
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>日检达人 - Master Japanese Pro</title>
    <!-- 基础样式与字体 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@600&display=swap');
        :root { --sakura: #ff6b9d; --safe-top: env(safe-area-inset-top); }
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #fffafb; -webkit-tap-highlight-color: transparent; overflow-x: hidden; scroll-behavior: smooth; }
        .japanese-serif { font-family: 'Noto Serif JP', serif; }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; z-index: 40; padding-top: var(--safe-top); background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #f1f1f1; }
        .content-pt { padding-top: calc(100px + var(--safe-top)); }
        @keyframes blink-green { 0%, 100% { opacity: 1; filter: drop-shadow(0 0 5px #10b981); } 50% { opacity: 0.7; } }
        .mastery-pulse { animation: blink-green 1.5s infinite; border: 2px solid #10b981 !important; }
        .option-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid transparent; }
        .option-btn:active { transform: scale(0.96); background-color: #fce7f3; }
        #fireworks { pointer-events: none; position: fixed; inset: 0; z-index: 100; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <canvas id="fireworks"></canvas>

    <!-- 依赖管理 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.2.3",
    "react-dom/client": "https://esm.sh/react-dom@19.2.3/client",
    "@google/genai": "https://esm.sh/@google/genai@1.37.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>

    <!-- 应用逻辑 -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI, Type } from "@google/genai";

        console.log("System Initializing...");

        // --- 1. 业务常量与初始题库 ---
        const JLPTLevel = { FIFTY_ON: '50音', N5: 'N5', N4: 'N4', N3: 'N3', N2: 'N2' };
        const Category = { KANA: '假名识别', VOCABULARY: '文字・词汇', GRAMMAR: '语法', LISTENING: '听力' };
        const STORAGE_KEY = 'jp_master_pro_v6_final';

        const INITIAL_BANK = [
            { id: 'k1', level: JLPTLevel.FIFTY_ON, category: Category.KANA, text: '「あ」的片假名是？', options: ['ア', 'イ', 'ウ', 'エ'], correctIndex: 0, translation: '“あ”对应的片假名。', coreAnalysis: 'あ对应ア。', wrongOptionsAnalysis: 'イ是い；ウ是う；エ是え。' },
            { id: 'k2', level: JLPTLevel.FIFTY_ON, category: Category.KANA, text: '「さ」的片假名是？', options: ['キ', 'サ', 'チ', 'ラ'], correctIndex: 1, translation: '“さ”对应的片假名。', coreAnalysis: 'さ对应サ。', wrongOptionsAnalysis: '辨析：チ是ち。' },
            { id: 'n5v1', level: JLPTLevel.N5, category: Category.VOCABULARY, text: 'あした、えいがを（　）。', options: ['みます', 'みました', 'みましょう', 'みてください'], correctIndex: 2, translation: '明天一起去看电影吧。', coreAnalysis: '「～ましょう」表示提议。', wrongOptionsAnalysis: '1.陈述; 2.过去; 4.命令。' },
            { id: 'n2g1', level: JLPTLevel.N2, category: Category.GRAMMAR, text: '合格できたのは、皆さんの応援が（　）のことです。', options: ['あって', 'ありながら', 'あるがゆえ', 'あってこそ'], correctIndex: 3, translation: '之所以能合格，正因为有了大家的支撑。', coreAnalysis: '「～あってこそ」强调唯一必要条件。', wrongOptionsAnalysis: '1.简单并列; 2.逆接; 3.因果语感不同。' }
        ];

        // 扩充初始题库至 50 道，防止 API 延迟时无题可做
        for(let i=0; i<46; i++) {
            const lvls = Object.values(JLPTLevel);
            const lvl = lvls[i % lvls.length];
            INITIAL_BANK.push({
                id: `seed_${i}`,
                level: lvl,
                category: lvl === JLPTLevel.FIFTY_ON ? Category.KANA : Category.VOCABULARY,
                text: `${lvl} 练习题 ${i+1}:（　）の意味を選びなさい。`,
                options: ['正解选项', '干扰 A', '干扰 B', '干扰 C'],
                correctIndex: 0,
                translation: '这是系统生成的补位翻译。',
                coreAnalysis: '考查等级对应的核心词汇。',
                wrongOptionsAnalysis: '其他选项语义不通。'
            });
        }

        // --- 2. 核心服务封装 ---
        const audio = {
            ctx: null,
            init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play(f, t, d) {
                this.init();
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type = t; o.frequency.setValueAtTime(f, this.ctx.currentTime);
                g.gain.setValueAtTime(0.1, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + d);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); o.stop(this.ctx.currentTime + d);
            },
            correct() { this.play(880, 'sine', 0.4); },
            wrong() { this.play(220, 'triangle', 0.5); }
        };

        const Fireworks = {
            canvas: null, ctx: null, particles: [], active: false,
            init() {
                this.canvas = document.getElementById('fireworks');
                if(!this.canvas) return;
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },
            spawn(x, y) {
                this.active = true;
                for(let i=0; i<60; i++){
                    this.particles.push({
                        x, y, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15,
                        color: `hsl(${Math.random()*360}, 100%, 60%)`, life: 1, size: Math.random()*3+2
                    });
                }
                this.animate();
            },
            animate() {
                if(!this.active) return;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.particles = this.particles.filter(p => p.life > 0);
                this.particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.life -= 0.012;
                    this.ctx.fillStyle = p.color;
                    this.ctx.globalAlpha = p.life;
                    this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); this.ctx.fill();
                });
                if(this.particles.length > 0) requestAnimationFrame(() => this.animate());
                else { this.active = false; this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); }
            }
        };

        // --- 3. 组件部分 ---

        const Loading = () => (
            <div className="flex flex-col items-center justify-center p-12 space-y-6">
                <div className="relative w-16 h-16">
                    <div className="absolute inset-0 border-4 border-pink-100 rounded-full animate-ping"></div>
                    <div className="absolute inset-0 border-4 border-pink-500 rounded-full border-t-transparent animate-spin"></div>
                </div>
                <p className="text-gray-400 font-bold animate-pulse text-sm">AI 正在精准排题中...</p>
            </div>
        );

        const ExplanationModal = ({ question, isCorrect, onNext }) => (
            <div className="fixed inset-0 z-[60] flex items-end bg-black/40 backdrop-blur-sm animate-in fade-in duration-300">
                <div className="bg-white w-full rounded-t-[3rem] p-8 max-h-[85vh] overflow-y-auto no-scrollbar shadow-2xl animate-in slide-in-from-bottom-20 duration-500">
                    <div className="flex items-center space-x-4 mb-6">
                        <div className={`w-14 h-14 rounded-full flex items-center justify-center text-2xl ${isCorrect ? 'bg-green-100 text-green-600' : 'bg-rose-100 text-rose-600'}`}>
                            <i className={`fa-solid ${isCorrect ? 'fa-check' : 'fa-times'}`}></i>
                        </div>
                        <div>
                            <h3 className="text-2xl font-black">{isCorrect ? '正解です！' : '不对哦'}</h3>
                            <p className="text-xs font-bold opacity-40">正确答案: {question.options[question.correctIndex]}</p>
                        </div>
                    </div>
                    <div className="space-y-6 pb-10">
                        <div className="bg-indigo-50/50 p-6 rounded-[2rem] border border-indigo-100 italic text-gray-700 text-lg leading-relaxed">
                            “ {question.translation} ”
                        </div>
                        <div className="p-2">
                            <p className="text-[10px] font-black text-green-500 mb-2 uppercase tracking-widest">核心解析 Analysis</p>
                            <p className="text-gray-800 font-medium leading-relaxed text-lg">{question.coreAnalysis}</p>
                        </div>
                        <div className="bg-gray-50 p-6 rounded-[2rem] border border-gray-100 text-gray-600 text-sm whitespace-pre-wrap leading-relaxed">
                            <p className="text-[10px] font-black text-rose-400 mb-2 uppercase tracking-widest">干扰项辨析 Distractors</p>
                            {question.wrongOptionsAnalysis}
                        </div>
                        <button onClick={onNext} className="w-full bg-indigo-600 text-white font-black py-6 rounded-[2rem] shadow-2xl shadow-indigo-100 flex items-center justify-center space-x-3 active:scale-95 transition-all">
                            <span>次へ / 下一题</span>
                            <i className="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        );

        // --- 4. 主应用逻辑 ---
        const App = () => {
            const [view, setView] = useState('dashboard');
            const [appData, setAppData] = useState(() => {
                const s = localStorage.getItem(STORAGE_KEY);
                return s ? JSON.parse(s) : { scores: {}, wrongQuestions: [], unlocked: [JLPTLevel.FIFTY_ON, JLPTLevel.N5] };
            });
            const [test, setTest] = useState({ level: JLPTLevel.N5, category: Category.VOCABULARY, queue: [], currentIndex: 0, showExp: false, isCorrect: null, isReview: false, loading: false });
            const [masteryModal, setMasteryModal] = useState(null);
            const [scoreAni, setScoreAni] = useState(false);

            useEffect(() => {
                Fireworks.init();
                window.addEventListener('resize', Fireworks.init);
                console.log("Master Ready ✅");
                return () => window.removeEventListener('resize', Fireworks.init);
            }, []);

            const save = (data) => {
                setAppData(data);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            };

            // AI 题库扩充逻辑
            const fetchMoreQuestions = async (lvl, cat) => {
                const key = process.env.API_KEY;
                if(!key) return INITIAL_BANK.filter(q => q.level === lvl && q.category === cat).sort(() => Math.random() - 0.5).slice(0, 10);
                
                const ai = new GoogleGenAI({ apiKey: key });
                const prompt = `生成 10 道日语测试题。等级：${lvl}，类别：${cat}。必须返回 JSON 数组格式。每个对象包含 text, options(4个), correctIndex, translation, coreAnalysis, wrongOptionsAnalysis。`;
                try {
                    const res = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: prompt,
                        config: { responseMimeType: "application/json" }
                    });
                    return JSON.parse(res.text).map(d => ({ ...d, id: Math.random().toString(36).substr(2, 9), level: lvl, category: cat }));
                } catch(e) {
                    return INITIAL_BANK.filter(q => q.level === lvl && q.category === cat).sort(() => Math.random() - 0.5).slice(0, 10);
                }
            };

            const startTest = async (lvl, cat, customQueue = null) => {
                setTest(p => ({ ...p, loading: !customQueue, level: lvl, category: cat, isReview: !!customQueue }));
                setView('test');
                window.scrollTo(0, 0);

                if(customQueue) {
                    setTest(p => ({ ...p, queue: customQueue, currentIndex: 0, showExp: false, loading: false }));
                } else {
                    const q = await fetchMoreQuestions(lvl, cat);
                    setTest(p => ({ ...p, queue: q, currentIndex: 0, showExp: false, loading: false }));
                }
            };

            const handleAnswer = (idx) => {
                const cur = test.queue[test.currentIndex];
                const correct = idx === cur.correctIndex;
                if(correct) audio.correct(); else audio.wrong();

                if(!test.isReview) {
                    const key = `${test.level}_${test.category}`;
                    const oldS = appData.scores[key] || 0;
                    const nextS = Math.max(0, oldS + (correct ? 10 : -5));
                    
                    const newData = { ...appData, scores: { ...appData.scores, [key]: nextS } };
                    if(!correct && !newData.wrongQuestions.find(q => q.id === cur.id)) {
                        newData.wrongQuestions.push(cur);
                    }

                    if(oldS < 100 && nextS >= 100) {
                        Fireworks.spawn(window.innerWidth/2, window.innerHeight/3);
                        setMasteryModal({ lvl: test.level, cat: test.category });
                        const lvls = Object.values(JLPTLevel);
                        const nextIdx = lvls.indexOf(test.level) + 1;
                        if(nextIdx < lvls.length && !newData.unlocked.includes(lvls[nextIdx])) newData.unlocked.push(lvls[nextIdx]);
                    }

                    setScoreAni(true);
                    setTimeout(() => setScoreAni(false), 500);
                    save(newData);
                }

                setTest(p => ({ ...p, isCorrect: correct, showExp: true }));
            };

            const next = async () => {
                if(test.currentIndex < test.queue.length - 1) {
                    setTest(p => ({ ...p, currentIndex: p.currentIndex + 1, showExp: false, isCorrect: null }));
                    window.scrollTo({top: 0, behavior: 'smooth'});
                } else if(test.isReview) {
                    setView('dashboard');
                } else {
                    // 智能续载
                    setTest(p => ({ ...p, loading: true }));
                    const more = await fetchMoreQuestions(test.level, test.category);
                    setTest(p => ({ ...p, queue: [...p.queue, ...more], currentIndex: p.currentIndex + 1, showExp: false, loading: false }));
                    window.scrollTo({top: 0, behavior: 'smooth'});
                }
            };

            const score = appData.scores[`${test.level}_${test.category}`] || 0;
            const mastered = score >= 100;

            return (
                <div className="min-h-screen flex flex-col">
                    {view === 'dashboard' && (
                        <div className="p-6 space-y-8 animate-in fade-in duration-500 max-w-lg mx-auto w-full pb-20">
                            <header className="flex justify-between items-end pt-6">
                                <div>
                                    <h1 className="text-4xl font-black text-gray-800 japanese-serif tracking-tighter">日检达人</h1>
                                    <p className="text-[10px] text-pink-400 font-bold uppercase tracking-widest mt-1">Japanese Mastery Pro</p>
                                </div>
                                <button onClick={() => setView('review')} className="bg-white p-4 rounded-3xl border border-gray-100 shadow-xl text-rose-500 active:scale-90 transition-all">
                                    <i className="fa-solid fa-ghost text-xl"></i>
                                    <span className="ml-2 text-sm font-black">{appData.wrongQuestions.length}</span>
                                </button>
                            </header>

                            <div className="grid gap-6">
                                {Object.values(JLPTLevel).map(lvl => {
                                    const unlocked = appData.unlocked.includes(lvl);
                                    const cats = lvl === JLPTLevel.FIFTY_ON ? [Category.KANA] : [Category.VOCABULARY, Category.GRAMMAR, Category.LISTENING];
                                    return (
                                        <div key={lvl} className={`bg-white rounded-[2.5rem] p-7 border-2 transition-all duration-500 ${unlocked ? 'border-pink-50 shadow-2xl shadow-gray-100' : 'opacity-40 grayscale pointer-events-none border-dashed'}`}>
                                            <div className="flex items-center justify-between mb-6">
                                                <h3 className="text-2xl font-black">{lvl}</h3>
                                                {!unlocked && <i className="fa-solid fa-lock text-gray-300"></i>}
                                            </div>
                                            <div className="grid gap-3">
                                                {cats.map(c => {
                                                    const s = appData.scores[`${lvl}_${c}`] || 0;
                                                    const m = s >= 100;
                                                    return (
                                                        <button key={c} onClick={() => startTest(lvl, c)} className="flex justify-between items-center p-5 bg-gray-50/50 rounded-2xl border border-transparent hover:border-pink-200 hover:bg-white active:scale-95 transition-all group">
                                                            <div className="flex flex-col text-left">
                                                                <span className="text-xs font-bold text-gray-500 group-hover:text-pink-500">{c}</span>
                                                                <span className="text-[9px] text-gray-400 font-medium italic">模块精通度: {Math.min(s, 100)}%</span>
                                                            </div>
                                                            <div className="flex items-center">
                                                                {m ? <i className="fa-solid fa-check-circle text-green-500 text-lg"></i> : <span className="text-sm font-black text-gray-700">{s}</span>}
                                                            </div>
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {view === 'test' && (
                        <div className="flex-1 flex flex-col content-pt px-6 max-w-lg mx-auto w-full">
                            <div className={`fixed-header px-4 py-3 flex flex-col shadow-md ${mastered ? 'mastery-pulse' : ''}`}>
                                <div className="flex items-center justify-between mb-2">
                                    <button onClick={() => setView('dashboard')} className="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-full text-gray-400 active:scale-90 transition-transform">
                                        <i className="fa-solid fa-chevron-left"></i>
                                    </button>
                                    <div className="flex flex-col items-center">
                                        <span className="text-[10px] font-black text-gray-400 uppercase tracking-tighter">{test.level} · {test.category}</span>
                                        <span className={`text-xs font-bold transition-all ${scoreAni ? 'scale-125 text-pink-500' : 'text-gray-700'}`}>
                                            模块精通度: {score}%
                                        </span>
                                    </div>
                                    <div className="w-10"></div>
                                </div>
                                <div className="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div className={`h-full transition-all duration-700 ease-out ${score <= 60 ? 'bg-orange-500' : (score <= 90 ? 'bg-blue-500' : 'bg-green-500')}`} style={{ width: `${Math.min(score, 100)}%` }}></div>
                                </div>
                            </div>

                            <div className="flex-1 flex flex-col py-6 space-y-10 animate-in slide-in-from-bottom-6 duration-500">
                                {test.loading ? <Loading /> : test.queue[test.currentIndex] ? (
                                    <>
                                        <div className="bg-white rounded-[2.5rem] p-10 shadow-xl border border-pink-50 text-center relative overflow-hidden">
                                            <div className="absolute top-0 left-0 w-1.5 h-full bg-pink-500"></div>
                                            <p className="text-3xl font-bold text-gray-800 japanese-serif leading-tight">
                                                {test.queue[test.currentIndex].text}
                                            </p>
                                        </div>
                                        <div className="grid gap-4 pb-12">
                                            {test.queue[test.currentIndex].options.map((opt, i) => (
                                                <button key={i} onClick={() => handleAnswer(i)} className="option-btn w-full p-6 bg-white border border-gray-100 rounded-[2rem] text-left shadow-sm flex items-center space-x-5 hover:border-pink-300 active:scale-95">
                                                    <span className="w-9 h-9 rounded-2xl bg-gray-50 flex items-center justify-center font-black text-gray-300 text-xs shadow-inner">{String.fromCharCode(65+i)}</span>
                                                    <span className="font-bold text-gray-700 text-lg">{opt}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </>
                                ) : <div className="text-center py-20 text-gray-300 italic">找不到题目，正在重试...</div>}
                            </div>
                        </div>
                    )}

                    {view === 'review' && (
                        <div className="p-6 animate-in slide-in-from-right-10 pt-10 max-w-lg mx-auto w-full pb-20">
                            <div className="flex items-center space-x-4 mb-10">
                                <button onClick={() => setView('dashboard')} className="w-12 h-12 rounded-full bg-white border flex items-center justify-center shadow-lg text-gray-400 active:scale-90 transition-all">
                                    <i className="fa-solid fa-arrow-left text-lg"></i>
                                </button>
                                <h2 className="text-3xl font-black tracking-tight">错题库</h2>
                            </div>
                            {appData.wrongQuestions.length === 0 ? (
                                <div className="text-center py-32 space-y-6">
                                    <div className="animate-float">
                                        <i className="fa-solid fa-trophy text-7xl text-yellow-400 drop-shadow-lg"></i>
                                    </div>
                                    <p className="text-gray-400 font-black text-xl">全清达成！你是日语天才</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {appData.wrongQuestions.map(q => (
                                        <div key={q.id} className="bg-white p-7 rounded-[2.5rem] border-2 border-gray-50 flex justify-between items-center shadow-md">
                                            <div className="flex-1 pr-6">
                                                <p className="text-[10px] font-black text-pink-400 mb-1 uppercase tracking-widest">{q.level} · {q.category}</p>
                                                <p className="font-bold text-gray-700 line-clamp-1 text-lg">{q.text}</p>
                                            </div>
                                            <button onClick={() => startTest(q.level, q.category, [q])} className="bg-rose-500 text-white px-5 py-2.5 rounded-2xl text-xs font-black shadow-lg active:scale-90 transition-all">挑战</button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {test.showExp && <ExplanationModal 
                        question={test.queue[test.currentIndex]} 
                        isCorrect={test.isCorrect} 
                        onNext={() => {
                            if(test.isReview && test.isCorrect) {
                                const newData = { ...appData, wrongQuestions: appData.wrongQuestions.filter(q => q.id !== test.queue[test.currentIndex].id) };
                                save(newData);
                            }
                            next();
                        }}
                    />}

                    {masteryModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-pink-500/20 backdrop-blur-xl p-6">
                            <div className="bg-white w-full max-w-sm rounded-[3.5rem] p-12 text-center shadow-2xl border-4 border-pink-50 animate-in zoom-in duration-500">
                                <i className="fa-solid fa-crown text-7xl text-yellow-400 mb-8 drop-shadow-xl animate-bounce"></i>
                                <h2 className="text-3xl font-black text-gray-800 mb-3">模块精通！</h2>
                                <p className="text-gray-500 text-sm leading-relaxed mb-10 italic">恭喜达成【{masteryModal.lvl} {masteryModal.cat}】100% 精通度。新关卡已开启！</p>
                                <div className="space-y-4">
                                    <button onClick={() => setMasteryModal(null)} className="w-full bg-pink-500 text-white font-black py-5 rounded-3xl shadow-xl shadow-pink-200 active:scale-95 transition-all">继续强化</button>
                                    <button onClick={() => { setMasteryModal(null); setView('dashboard'); }} className="w-full bg-gray-100 text-gray-500 font-bold py-5 rounded-3xl active:scale-95 transition-all">返回主页</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
